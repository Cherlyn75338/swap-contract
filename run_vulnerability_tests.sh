#!/bin/bash

# Vulnerability Test Runner Script
# This script helps you run the vulnerability tests manually

set -e

echo "🔍 Starting Vulnerability Tests for Swap Contract"
echo "================================================="

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "❌ Error: Cargo is not installed. Please install Rust and Cargo first."
    echo "   Visit: https://rustup.rs/"
    exit 1
fi

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo "❌ Error: Please run this script from the project root directory."
    exit 1
fi

# Check if the swap contract exists
if [ ! -d "contracts/swap" ]; then
    echo "❌ Error: contracts/swap directory not found."
    exit 1
fi

echo "✅ Environment checks passed"
echo ""

# Install required toolchain if needed
echo "🔧 Setting up Rust toolchain..."
rustup toolchain install 1.78.0 2>/dev/null || true
rustup default 1.78.0

# Add WASM target if needed
echo "🔧 Adding WASM target..."
rustup target add wasm32-unknown-unknown

echo ""
echo "🧪 Running vulnerability tests..."
echo "=================================="

# Change to swap contract directory and run tests
cd contracts/swap

# Run the vulnerability tests with detailed output
cargo test vulnerability_tests --lib -- --nocapture --test-threads=1

echo ""
echo "📊 Test Results Summary:"
echo "========================"

if [ $? -eq 0 ]; then
    echo "✅ All vulnerability tests passed!"
    echo ""
    echo "⚠️  IMPORTANT NOTE:"
    echo "   These tests CONFIRM that vulnerabilities exist in the contract."
    echo "   Passing tests mean the vulnerabilities are detectable and exploitable."
    echo ""
    echo "🔍 Vulnerabilities Detected:"
    echo "   1. Global state overwrite vulnerability"
    echo "   2. Lack of user isolation in swap operations"
    echo "   3. Fund theft potential through state manipulation"
    echo "   4. Race conditions in concurrent swaps"
    echo "   5. Dirty state left by failed transactions"
    echo ""
    echo "🛠️  Recommended Fix:"
    echo "   Replace Item<CurrentSwapOperation> with Map<Addr, CurrentSwapOperation>"
    echo "   to provide proper user isolation."
else
    echo "❌ Some vulnerability tests failed!"
    echo "   This might indicate issues with the test setup or environment."
fi

echo ""
echo "🔗 For more details, check the test output above."
echo "📝 Tests are located in: contracts/swap/src/testing/vulnerability_test.rs"